<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ì‚¬ ëŒ€ì‹œë³´ë“œ - CareNote (OB/GYN)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: "Inter", sans-serif; }
        .page-section { display: none; width: 100%; height: 100vh; }
        .page-section.active { display: flex; }
        
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        /* ëª¨ë‹¬ í¬ê¸° í™•ì¥ */
        .modal-content-report { background-color: #f9fafb; padding: 2rem; border-radius: 0.75rem; width: 90%; max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column; }
        
        #reportContent { background: white; border-radius: 0.5rem; padding: 2rem; overflow-y: auto; flex-grow: 1; }
        .report-section { margin-bottom: 1rem; border-bottom: 1px solid #f3f4f6; padding-bottom: 0.75rem; }
        .report-q { font-size: 0.85rem; font-weight: 600; color: #6b7280; margin-bottom: 0.25rem; }
        .report-a { font-size: 1.05rem; color: #111827; white-space: pre-wrap; line-height: 1.5; font-weight: 500; }
        .section-header { font-size: 1.2rem; font-weight: 800; color: #be185d; margin-top: 2rem; margin-bottom: 1rem; border-left: 5px solid #be185d; padding-left: 1rem; }
        
        .ai-card { background-color: #fff1f2; border: 1px solid #fecdd3; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1.5rem; }
        .keyword-tag { background-color: #fce7f3; color: #9d174d; padding: 0.25rem 0.75rem; border-radius: 9999px; margin-right: 0.5rem; font-size: 0.85rem; font-weight: 600; }
        .question-box { background-color: #f0fdf4; border: 1px solid #bbf7d0; padding: 1rem; border-radius: 0.5rem; margin-top: 0.5rem; }
        .question-item { display: flex; align-items: start; gap: 0.5rem; margin-bottom: 0.5rem; color: #166534; font-weight: 500; }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #e11d48; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 h-screen">

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="authContainer" class="page-section active items-center justify-center bg-rose-50">
        <div class="bg-white p-10 rounded-lg shadow-xl w-full max-w-md text-center border-t-4 border-rose-500">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">ì‚°ë¶€ì¸ê³¼ ì „ë¬¸ì˜ ë¡œê·¸ì¸</h2>
            <form id="loginForm">
                <input type="email" id="loginEmail" class="block w-full mb-4 p-3 border rounded focus:ring-rose-500 focus:border-rose-500" placeholder="ì´ë©”ì¼">
                <input type="password" id="loginPassword" class="block w-full mb-6 p-3 border rounded focus:ring-rose-500 focus:border-rose-500" placeholder="ë¹„ë°€ë²ˆí˜¸">
                <button type="submit" class="w-full bg-rose-600 text-white py-3 rounded font-bold hover:bg-rose-700 transition">ë¡œê·¸ì¸</button>
            </form>
        </div>
    </div>

    <!-- ëŒ€ì‹œë³´ë“œ í™”ë©´ -->
    <div id="doctorDashboardPage" class="page-section">
        <aside class="w-72 bg-white h-full p-6 flex flex-col border-r">
            <h2 class="text-2xl font-bold text-rose-600 mb-8 flex items-center gap-2">CareNote OBGYN</h2>
            <nav class="flex-1">
                <ul>
                    <li class="mb-2"><a href="#" class="block p-3 rounded bg-rose-50 text-rose-700 font-bold">ëŒ€ê¸°ì ëª…ë‹¨</a></li>
                    <li><a href="patient.html" target="_blank" class="block p-3 rounded hover:bg-gray-100 text-gray-600">í™˜ììš© í™”ë©´ &nearr;</a></li>
                </ul>
            </nav>
            <button id="logoutButton" class="mt-auto text-gray-500 hover:text-red-600">ë¡œê·¸ì•„ì›ƒ</button>
        </aside>
        
        <main class="flex-1 p-10 bg-gray-50 overflow-y-auto">
            <div class="flex justify-between items-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">ì§„ë£Œ ëŒ€ê¸°ì‹¤</h1>
                <button id="addPatientBtn" class="bg-rose-600 text-white px-5 py-2 rounded-lg hover:bg-rose-700 transition">í™˜ì ë“±ë¡</button>
            </div>
            <div id="waitingListContainer" class="space-y-4">
                <!-- í™˜ì ë¦¬ìŠ¤íŠ¸ ë¡œë”© -->
            </div>
        </main>
    </div>

    <!-- ë¦¬í¬íŠ¸ ëª¨ë‹¬ -->
    <div id="reportModal" class="modal">
        <div class="modal-content-report relative">
            <button id="closeReportBtn" class="absolute top-6 right-6 text-3xl text-gray-400 hover:text-gray-700">&times;</button>
            <div class="mb-6 pb-2 border-b flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">AI ìŠ¤ë§ˆíŠ¸ ë¬¸ì§„ ë¦¬í¬íŠ¸</h2>
                    <p class="text-sm text-gray-500">Artificial Intelligence Clinical Summary</p>
                </div>
            </div>
            
            <div id="reportContent" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- ì™¼ìª½: AI ë¶„ì„ ë° ì°¨íŠ¸ -->
                <div id="aiSection"></div>
                <!-- ì˜¤ë¥¸ìª½: ì›ë³¸ ë¬¸ì§„ ë°ì´í„° -->
                <div id="dataSection" class="overflow-y-auto max-h-[70vh] pr-2"></div>
            </div>
        </div>
    </div>
    
    <!-- í™˜ì ë“±ë¡ ëª¨ë‹¬ -->
    <div id="patientModal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-xl w-96">
            <h2 class="text-xl font-bold mb-4 text-gray-800">í™˜ì ë“±ë¡</h2>
            <input id="newPatientName" class="w-full border p-3 rounded mb-3" placeholder="ì´ë¦„">
            <input id="newPatientBirth" class="w-full border p-3 rounded mb-6" placeholder="ìƒë…„ì›”ì¼ (ì˜ˆ: 990101)">
            <div class="flex justify-end gap-2">
                <button id="cancelAddPatient" class="bg-gray-200 text-gray-700 px-4 py-2 rounded">ì·¨ì†Œ</button>
                <button id="confirmAddPatient" class="bg-rose-600 text-white px-4 py-2 rounded">ë“±ë¡</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAcxnduVJ5MpaUOzGmG1DmbUJKuUr5Uhzo",
            authDomain: "doctor-cba8a.firebaseapp.com",
            projectId: "doctor-cba8a",
            storageBucket: "doctor-cba8a.firebasestorage.app",
            messagingSenderId: "899440797117",
            appId: "1:899440797117:web:78a9f0f9b6a91b2d5b5ed4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentChart = null; // ì°¨íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ì €ì¥

        // ì¸ì¦ ë° ì´ˆê¸°í™”
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('authContainer').classList.remove('active');
                document.getElementById('doctorDashboardPage').classList.add('active');
                setupWaitingList();
            } else {
                document.getElementById('authContainer').classList.add('active');
                document.getElementById('doctorDashboardPage').classList.remove('active');
            }
        });

        // ëŒ€ê¸°ì ëª…ë‹¨
        function setupWaitingList() {
            const q = query(collection(db, "artifacts", 'default-symptom-tracker', "public", "data", "waiting_list"), orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('waitingListContainer');
                container.innerHTML = "";
                if (snapshot.empty) container.innerHTML = "<p class='text-gray-500 text-center py-10'>ëŒ€ê¸° í™˜ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                
                snapshot.forEach(docSnap => {
                    const p = docSnap.data();
                    const div = document.createElement('div');
                    div.className = "bg-white p-6 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center hover:shadow-md transition";
                    
                    let statusBadge = `<span class='px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-500'>ëŒ€ê¸°ì¤‘</span>`;
                    if (p.status === 'completed') statusBadge = `<span class='px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-600'>ë¬¸ì§„ì™„ë£Œ</span>`;

                    div.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div><h3 class="text-lg font-bold text-gray-800">${p.name}</h3><p class="text-sm text-gray-500">${p.birthdate}</p></div>
                            ${statusBadge}
                        </div>
                        <div class="flex gap-3">
                            ${p.status === 'completed' ? `<button class="view-report-btn bg-rose-600 text-white px-4 py-2 rounded-lg hover:bg-rose-700 text-sm font-bold shadow-sm" data-id="${docSnap.id}">ë¦¬í¬íŠ¸ ë³´ê¸°</button>` : ''}
                            <button class="delete-btn text-gray-400 hover:text-red-500 p-2" data-id="${docSnap.id}">&times;</button>
                        </div>
                    `;
                    container.appendChild(div);
                });

                document.querySelectorAll('.delete-btn').forEach(btn => btn.onclick = async () => await deleteDoc(doc(db, "artifacts", 'default-symptom-tracker', "public", "data", "waiting_list", btn.dataset.id)));
                document.querySelectorAll('.view-report-btn').forEach(btn => btn.onclick = () => showReport(btn.dataset.id));
            });
        }

        // [í•µì‹¬] ë¦¬í¬íŠ¸ ë° ì°¨íŠ¸ ìƒì„±
        async function showReport(id) {
            const modal = document.getElementById('reportModal');
            const aiSection = document.getElementById('aiSection');
            const dataSection = document.getElementById('dataSection');
            modal.classList.add('active');
            
            // ì´ˆê¸°í™”
            aiSection.innerHTML = `<div class="text-center py-20"><div class="loader"></div><p class="mt-4 text-rose-600 font-bold">AI ì‚°ë¶€ì¸ê³¼ ì „ë¬¸ì˜ê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p></div>`;
            dataSection.innerHTML = "";

            try {
                const docSnap = await getDoc(doc(db, "artifacts", 'default-symptom-tracker', "public", "data", "waiting_list", id));
                const data = docSnap.data();
                const q = data.questionnaireData;

                const res = await fetch('http://localhost:3000/summarize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ questionnaireData: q })
                });
                const aiResult = await res.json();

                // 1. AI ì„¹ì…˜ ë Œë”ë§ (ìš”ì•½ + ì°¨íŠ¸ + ì§ˆë¬¸)
                aiSection.innerHTML = `
                    <div class="ai-card">
                        <h3 class="text-xl font-bold text-rose-800 mb-2 flex items-center gap-2">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                            AI ì„ìƒ ìš”ì•½
                        </h3>
                        <p class="text-gray-800 font-medium leading-relaxed mb-4">${aiResult.summary}</p>
                        <div class="flex flex-wrap gap-2 mb-4">
                            ${aiResult.keywords.map(k => `<span class="keyword-tag">#${k}</span>`).join('')}
                        </div>
                        <div class="border-t border-rose-200 pt-4">
                            <h4 class="font-bold text-rose-700 mb-2">ì¦ìƒ ëŒ€ì‹œë³´ë“œ</h4>
                            <div style="height: 250px; width: 100%; position: relative;">
                                <canvas id="symptomChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="question-box">
                        <h4 class="font-bold text-green-800 mb-2 flex items-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            ì¶”ê°€ ë¬¸ì§„ ì œì•ˆ
                        </h4>
                        <ul class="space-y-2">
                            ${aiResult.doctor_questions.map(q => `<li class="question-item"><span>â€¢</span> ${q}</li>`).join('')}
                        </ul>
                    </div>
                `;

                // 2. ì°¨íŠ¸ ê·¸ë¦¬ê¸°
                const ctx = document.getElementById('symptomChart').getContext('2d');
                if (currentChart) currentChart.destroy();
                
                currentChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['í†µì¦(Pain)', 'ì¶œí˜ˆ/ë¶„ë¹„ë¬¼', 'ê¸´ê¸‰ë„(Urgency)', 'ìŠ¤íŠ¸ë ˆìŠ¤', 'ì„ìƒì  ì‹¬ê°ë„'],
                        datasets: [{
                            label: 'í™˜ì ì¦ìƒ ì§€í‘œ',
                            data: [
                                aiResult.chart_data.pain, 
                                aiResult.chart_data.bleeding, 
                                aiResult.chart_data.urgency, 
                                aiResult.chart_data.stress, 
                                aiResult.chart_data.severity
                            ],
                            backgroundColor: 'rgba(225, 29, 72, 0.2)', // Rose-600 transparent
                            borderColor: 'rgba(225, 29, 72, 1)',
                            pointBackgroundColor: 'rgba(225, 29, 72, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: { display: true },
                                suggestedMin: 0,
                                suggestedMax: 10,
                                ticks: { stepSize: 2, backdropColor: 'transparent' } // ë°°ê²½ìƒ‰ íˆ¬ëª…
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });

                // 3. ì›ë³¸ ë°ì´í„° ì„¹ì…˜ ë Œë”ë§ (ê¸°ì¡´ ë¡œì§ + ìŠ¤íƒ€ì¼ ê°œì„ )
                const joinArr = (arr) => (arr && arr.length > 0) ? arr.join(', ') : '-';
                const makeSection = (label, value, isBold=false) => `
                    <div class="report-section">
                        <p class="report-q">${label}</p>
                        <p class="report-a ${isBold ? 'font-bold text-rose-700' : ''}">${value || '-'}</p>
                    </div>`;

                let rawHtml = `<div class="section-header">ë¬¸ì§„í‘œ ì›ë³¸ ë°ì´í„°</div>`;
                
                // ê³µí†µ ì •ë³´
                rawHtml += `<div class="grid grid-cols-2 gap-4 mb-4">
                    ${makeSection('LMP (ë§ˆì§€ë§‰ ìƒë¦¬ì¼)', q.common_lmp, true)}
                    ${makeSection('ì‚°ê³¼ë ¥ (G-P-A)', q.common_gpa)}
                    <div class="col-span-2">${makeSection('ê¸°ì €ì§ˆí™˜/ê³¼ê±°ë ¥', q.common_history)}</div>
                    <div class="col-span-2">${makeSection('í™˜ì ë¬¸ì˜ì‚¬í•­', q.common_goals)}</div>
                </div>`;

                // ì¹´í…Œê³ ë¦¬ë³„ ìƒì„¸
                if (q.category === 'pregnancy') {
                    rawHtml += `<div class="section-header">ğŸ¤° ì„ì‹  ê´€ë¦¬</div>
                        ${makeSection('í…ŒìŠ¤íŠ¸ê¸° ê²°ê³¼', q.preg_test_result)}
                        ${makeSection('ì¶”ì • ì£¼ìˆ˜', q.preg_weeks)}
                        ${makeSection('ì£¼ìš” ì¦ìƒ', joinArr(q.preg_symptoms), true)}
                        ${makeSection('ì‚°ê³¼ë ¥ íŠ¹ì´ì‚¬í•­', q.preg_history_detail)}
                        ${makeSection('ë³µìš© ì•½ë¬¼', q.preg_meds)}`;
                } else if (q.category === 'period') {
                    rawHtml += `<div class="section-header">ğŸ©¸ ìƒë¦¬ ê´€ë ¨</div>
                        ${makeSection('ì£¼í˜¸ì†Œ', joinArr(q.period_symptom), true)}
                        ${makeSection('í†µì¦ ì ìˆ˜ (NRS)', q.period_pain_score + 'ì ', true)}
                        ${makeSection('ìƒë¦¬ ì–‘', q.period_amount)}
                        ${makeSection('ìƒí™œ ë³€í™”', q.period_change)}
                        ${makeSection('ê°€ì¡±ë ¥', q.period_family)}`;
                }
                // (ë‚˜ë¨¸ì§€ ì¹´í…Œê³ ë¦¬ë„ ë™ì¼í•œ íŒ¨í„´ìœ¼ë¡œ ë Œë”ë§)
                // ... ê³µê°„ìƒ ìƒëµ, ì‹¤ì œ êµ¬í˜„ ì‹œ ìœ„ì˜ patient.html ë¡œì§ ì°¸ê³ í•˜ì—¬ ëª¨ë“  í•„ë“œ ì¶”ê°€

                dataSection.innerHTML = rawHtml;

            } catch (err) {
                console.error(err);
                aiSection.innerHTML = `<p class="text-red-500">ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
            }
        }

        // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì´ë²¤íŠ¸ ì—°ê²° (ê¸°ì¡´ê³¼ ë™ì¼)
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value); } 
            catch (err) { document.getElementById('authError').textContent = "ë¡œê·¸ì¸ ì‹¤íŒ¨"; }
        });
        document.getElementById('logoutButton').onclick = () => signOut(auth);
        document.getElementById('closeReportBtn').onclick = () => document.getElementById('reportModal').classList.remove('active');
        
        // í™˜ì ë“±ë¡ ë¡œì§ (ê¸°ì¡´ê³¼ ë™ì¼)
        const patientModal = document.getElementById('patientModal');
        document.getElementById('addPatientBtn').onclick = () => patientModal.classList.add('active');
        document.getElementById('cancelAddPatient').onclick = () => patientModal.classList.remove('active');
        document.getElementById('confirmAddPatient').onclick = async () => {
            const name = document.getElementById('newPatientName').value;
            const birth = document.getElementById('newPatientBirth').value;
            if (name && birth) {
                await addDoc(collection(db, "artifacts", 'default-symptom-tracker', "public", "data", "waiting_list"), {
                    name, birthdate: birth, status: 'waiting', createdAt: new Date()
                });
                patientModal.classList.remove('active');
            }
        };
    </script>
</body>
</html>